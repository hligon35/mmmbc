MMMBC Admin Backend â€” Security & Reliability Audit Report
Date: 2026-01-16
Scope: admin/server.js (Express backend) + supporting admin JS client wiring

Summary
- Added modular centralized logging (Winston + daily rotation) and an audit trail.
- Added CSRF protection for authenticated state-changing API calls, with a token endpoint and client header wiring.
- Hardened sessions and login flow (rate limiting + session regeneration).
- Added optional HTTPS enforcement + HSTS and tightened baseline security headers.
- Added a small integration test suite (Jest + Supertest) to validate auth + CSRF.

Applied Changes (Implementation)
1) HTTPS enforcement + HSTS
- Implemented optional HTTPS-only enforcement:
  - Enabled automatically when NODE_ENV=production OR ENFORCE_HTTPS=true.
  - Redirects GET/HEAD to https:// and blocks non-idempotent requests over HTTP.
- Added HSTS when HTTPS enforcement is enabled.

2) Session & Authentication Hardening
- Session cookies:
  - HttpOnly: true
  - SameSite: lax
  - Secure: 'auto' when NODE_ENV=production (requires trust proxy)
- Login brute-force protection:
  - Added /api/auth/login rate limiting (10 attempts per 15 minutes per IP).
- Session fixation mitigation:
  - Regenerates the session on successful login before setting req.session.user.
- MFA hooks:
  - TOTP 2FA was already implemented (speakeasy + onboarding and verification) and remains intact.

3) CSRF Protection
- Added CSRF protection for authenticated state-changing /api/* routes.
- Exempted: /api/auth/login, /api/auth/logout, /api/auth/recover, and /api/invites/* (token-based flow).
- Added token endpoint:
  - GET /api/csrf (requires auth)
- Updated admin/public/admin.js to:
  - Fetch CSRF token after login and when resuming an authenticated session.
  - Automatically attach X-CSRF-Token for POST/PUT/DELETE requests.
  - Attach X-CSRF-Token for multipart uploads (gallery + bulletins).

4) Security Headers
- Helmet is configured with CSP OFF by default to avoid breaking existing UI.
- CSP is opt-in via ENABLE_CSP=true.
- Also disabled x-powered-by.

5) Encryption at Rest (Sensitive Secrets)
- Added optional AES-256-GCM encryption for sensitive user fields in admin/data/users.json:
  - twoFactorSecret
  - twoFactorPendingSecret
- Controlled by env var DATA_ENCRYPTION_KEY (32 bytes, base64/base64url encoded).
- Backward compatible:
  - Reads plaintext or encrypted values.
  - Writes encrypted values when the key is present.

6) Centralized Logging + Debug Hooks
- Added admin/lib/logger.js:
  - app logs: logs/app-YYYY-MM-DD.log
  - audit logs: logs/audit-YYYY-MM-DD.log
  - rotates daily; 10MB max per file; keeps 14 days; gzips archives
- Added request logging middleware (method, path, status, latency, userId).
- Added audit trail for admin actions (non-GET /api requests), redacting common secret fields.
- Added secured debug endpoints:
  - GET /api/admin/health (requires auth)
  - GET /api/admin/logs?type=app|audit&lines=300 (requires auth)

7) Performance & Reliability
- Enabled HTTP response compression (compression middleware).
- Added lightweight JSON file caching with mtime/size invalidation.
- Refactored server boot so tests can initialize without opening a port.

Tests & Validation
- Added Jest + Supertest integration tests:
  - admin/__tests__/auth_csrf.test.js
  - Validates:
    - /api/csrf requires auth
    - successful login
    - POST without CSRF fails (403)
    - POST with CSRF succeeds
- Commands:
  - npm test
  - npm run audit

Known Remaining Risks / Follow-ups
1) csurf dependency status
- csurf is archived and npm audit reports a low severity advisory via its cookie dependency:
  - Recommend replacing csurf with a maintained approach (e.g., csrf-csrf double-submit cookie pattern)
  - NOTE: npm audit suggests a breaking downgrade; do NOT apply blindly.

2) CSP enablement
- CSP is off by default to prevent breaking the existing admin UI.
- For internet-facing deployments, enable CSP and then tighten directives (remove unsafe-inline where possible).

3) Production TLS
- HTTPS enforcement and Secure cookies require a proper TLS terminator and correct proxy headers.
- Ensure your reverse proxy sets X-Forwarded-Proto=https and Express trust proxy is appropriate.

4) Role-based access control depth
- RBAC currently enforces admin role (existing behavior).
- If you add editor/viewer roles later, add explicit requireRole middleware and route-level authorization rules.

5) Data-at-rest scope
- Only 2FA secrets are encrypted-at-rest when DATA_ENCRYPTION_KEY is configured.
- If you store additional sensitive fields in JSON in the future, extend the encrypt/decrypt mapping accordingly.

Files Changed / Added
- admin/server.js
- admin/package.json
- admin/public/admin.js
- admin/lib/logger.js (new)
- admin/lib/crypto.js (new)
- admin/jest.config.cjs (new)
- admin/__tests__/auth_csrf.test.js (new)
- SECURITY_AUDIT_REPORT.txt (this file)

Deployment Checklist (Recommended)
- Set strong env vars: SESSION_SECRET, ADMIN_PASSWORD, ADMIN_EMAIL
- Set DATA_ENCRYPTION_KEY (32-byte base64) to encrypt 2FA secrets at rest
- Set NODE_ENV=production and ENFORCE_HTTPS=true behind TLS
- Consider enabling ENABLE_CSP=true after verifying the admin UI still renders correctly
- Review logs/ retention policy (logs directory) and restrict OS-level access
